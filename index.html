<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pluto Chatbot</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Showdown.js for Markdown Rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        :root { --bg-light: #f1f5f9; }
        html, body { overflow: hidden; height: 100%; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-light); }
        #chat-history::-webkit-scrollbar, #chat-previews::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track, #chat-previews::-webkit-scrollbar-track { background: transparent; }
        #chat-history::-webkit-scrollbar-thumb, #chat-previews::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; } .prose ol { list-style-type: decimal; padding-left: 1.5rem; }
        .hidden { display: none; }
        #background-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .chat-preview-card-content { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        /* Prevent auto-zoom on input focus on mobile */
        #message-input, #login-form input, #signup-form input, #profile-form input {
            font-size: 16px;
        }
        /* Increase chat font size */
        .prose {
            font-size: 0.95rem;
            line-height: 1.6;
        }
        /* Loading spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* Blinking logo animation */
        @keyframes blink-smooth {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .blinking-logo {
            animation: blink-smooth 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="text-slate-800 flex items-center justify-center text-sm">

    <!-- Canvas for background animation -->
    <canvas id="background-canvas"></canvas>
    
    <!-- Login/Signup Modal (Initially Hidden) -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-8 relative">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-2xl text-slate-400 hover:text-slate-600">&times;</button>
            <div class="text-center mb-8">
                <img src="https://media.istockphoto.com/id/1331167052/vector/letter-p-paper-logo-template-design.jpg?s=612x612&w=0&k=20&c=HQVvPVRw6ePUu6rWPTP7TpqEDM_n7xJOhtccMxks2m8=" alt="Pluto Logo" class="w-16 h-16 rounded-full mx-auto mb-4 shadow-lg">
                <h1 class="text-3xl font-bold text-black">Welcome to Pluto</h1>
            </div>
            <!-- Tabs -->
            <div class="flex border-b border-slate-200 mb-6">
                <button id="login-tab" class="flex-1 font-semibold py-2 text-black border-b-2 border-black">Log In</button>
                <button id="signup-tab" class="flex-1 font-semibold py-2 text-slate-400">Sign Up</button>
            </div>
            <!-- Forms -->
            <form id="login-form">
                <input id="login-email" type="email" placeholder="Email" class="w-full bg-slate-100 rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-black" required>
                <input id="login-password" type="password" placeholder="Password" class="w-full bg-slate-100 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-black" required>
                <button type="submit" class="w-full bg-black text-white font-semibold rounded-lg py-2.5 hover:bg-gray-800 transition-colors flex items-center justify-center">Log In</button>
                <p id="login-error" class="text-red-500 text-xs mt-2 text-center h-4"></p>
            </form>
            <form id="signup-form" class="hidden">
                <input id="signup-email" type="email" placeholder="Email" class="w-full bg-slate-100 rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-black" required>
                <input id="signup-password" type="password" placeholder="Password" class="w-full bg-slate-100 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-black" required>
                <button type="submit" class="w-full bg-black text-white font-semibold rounded-lg py-2.5 hover:bg-gray-800 transition-colors flex items-center justify-center">Create Account</button>
                <p id="signup-error" class="text-red-500 text-xs mt-2 text-center h-4"></p>
            </form>
        </div>
    </div>

    <!-- Edit Profile Modal (Initially Hidden) -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-8 relative">
            <button id="close-profile-modal-btn" class="absolute top-3 right-3 text-2xl text-slate-400 hover:text-slate-600">&times;</button>
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-black">Edit Profile</h1>
            </div>
            <form id="profile-form">
                <input id="display-name-input" type="text" placeholder="Display Name" class="w-full bg-slate-100 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-black" required>
                <button type="submit" class="w-full bg-black text-white font-semibold rounded-lg py-2.5 hover:bg-gray-800 transition-colors flex items-center justify-center">Save Changes</button>
                <p id="profile-error" class="text-red-500 text-xs mt-2 text-center h-4"></p>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="w-full h-full flex items-center justify-center p-4">
        <div class="w-full h-full flex flex-col bg-white/80 backdrop-blur-sm sm:max-w-2xl sm:h-[80vh] rounded-2xl border border-slate-200/80 shadow-2xl">
            <!-- Header -->
            <header class="p-4 border-b border-slate-200/80 flex items-center justify-between flex-shrink-0 shadow-sm z-10">
                <div class="relative">
                    <button id="auth-button" class="flex items-center gap-2 text-left rounded-lg p-1 -ml-1 hover:bg-slate-100 transition-colors">
                        <img src="https://media.istockphoto.com/id/1331167052/vector/letter-p-paper-logo-template-design.jpg?s=612x612&w=0&k=20&c=HQVvPVRw6ePUu6rWPTP7TpqEDM_n7xJOhtccMxks2m8=" alt="Pluto Logo" class="w-8 h-8 rounded-full shadow-lg flex-shrink-0">
                        <div>
                            <h1 class="text-xl font-bold text-black">Pluto</h1>
                            <p id="user-status" class="text-xs text-slate-500 font-mono truncate max-w-[150px]">Guest Mode</p>
                        </div>
                    </button>
                    <!-- Profile Dropdown -->
                    <div id="profile-dropdown" class="hidden absolute top-full mt-2 left-0 w-48 bg-white rounded-lg shadow-xl border border-slate-200/80 z-20">
                        <div class="p-2">
                            <button id="edit-profile-button" class="w-full text-left px-3 py-1.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">Edit Profile</button>
                            <button id="signout-button" class="w-full text-left px-3 py-1.5 text-sm text-red-600 rounded-md hover:bg-slate-100">Sign Out</button>
                        </div>
                    </div>
                </div>
                <div id="live-clock" class="flex items-center gap-2 text-sm text-slate-500 font-medium text-right">
                    <span id="time-icon"></span>
                    <div id="time-display"></div>
                </div>
            </header>
            <!-- Chat History Slider Panel -->
            <div class="w-full bg-white/50 border-b border-slate-200/80 p-3 flex-shrink-0">
                <div id="chat-previews" class="flex items-center gap-3 overflow-x-auto pb-2"></div>
            </div>
            <!-- Chat History -->
            <main id="chat-history" class="flex-1 p-4 overflow-y-auto space-y-4 bg-transparent min-h-0"></main>
            <!-- Footer -->
            <footer class="p-4 bg-white/80 backdrop-blur-sm border-t border-slate-200/80 flex-shrink-0 shadow-[0_-2px_5px_rgba(0,0,0,0.05)] z-10">
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="text" id="message-input" placeholder="Ask Pluto..." class="w-full bg-slate-100 text-black rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-black" required autocomplete="off">
                    <button type="submit" id="send-button" class="bg-black hover:bg-gray-800 text-white font-semibold rounded-lg p-2 w-10 h-10 flex items-center justify-center flex-shrink-0"></button>
                </form>
            </footer>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const authModal = document.getElementById('auth-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const authButton = document.getElementById('auth-button');
        const loginTab = document.getElementById('login-tab');
        const signupTab = document.getElementById('signup-tab');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const signoutButton = document.getElementById('signout-button');
        const userStatusEl = document.getElementById('user-status');
        const clockElement = document.getElementById('live-clock');
        const timeIconEl = document.getElementById('time-icon');
        const timeDisplayEl = document.getElementById('time-display');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatHistoryEl = document.getElementById('chat-history');
        const chatPreviewsEl = document.getElementById('chat-previews');
        const sendButton = document.getElementById('send-button');
        const profileDropdown = document.getElementById('profile-dropdown');
        const editProfileButton = document.getElementById('edit-profile-button');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileForm = document.getElementById('profile-form');
        const displayNameInput = document.getElementById('display-name-input');

        // --- State Management ---
        let allChats = [], activeChatId = null, isGenerating = false;
        let userId = null, db = null, auth = null, chatsUnsubscribe = null, isGuest = true;
        let responseAbortController = null;
        let typingInterval = null;

        // --- Converters & Config ---
        const markdownConverter = new showdown.Converter({ openLinksInNewWindow: true });
        
        // --- UI Icons ---
        const sendIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>`;
        const stopIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="6" width="12" height="12" rx="1"></rect></svg>`;
        const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
        const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
        const loadingSpinner = `<svg class="spinner w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
        const cloudSunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 16.5A4.5 4.5 0 1 1 7.5 12a4.5 4.5 0 0 1 4.5 4.5z"></path><path d="M12 7.27V12h4.73"></path><path d="M17.5 17.5a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9z"></path><path d="M22 17.5a4.5 4.5 0 0 0-4.5-4.5H13a8 8 0 0 0-8 8h12.5A4.5 4.5 0 0 0 22 17.5z"></path></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            const firebaseConfig = {
              apiKey: "AIzaSyDAg5A4dJ1ZcNb8lsmUZw2k3C9wv2rPSQo",
              authDomain: "pluto-a0033.firebaseapp.com",
              projectId: "pluto-a0033",
              storageBucket: "pluto-a0033.appspot.com",
              messagingSenderId: "688071466792",
              appId: "1:688071466792:web:caad0e69f4ae23d4fb7a1d",
              measurementId: "G-X5GRJZRRG1"
            };

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, handleAuthStateChange);
            } catch (error) {
                console.error("Firebase init error:", error);
                handleAuthStateChange(null);
            }
        }
        
        // --- Centralized Auth State Handler ---
        function handleAuthStateChange(user) {
            if (chatsUnsubscribe) {
                chatsUnsubscribe();
                chatsUnsubscribe = null;
            }
            allChats = [];
            activeChatId = null;
            chatHistoryEl.innerHTML = '';
            chatPreviewsEl.innerHTML = '';

            if (user && !user.isAnonymous) {
                userId = user.uid;
                isGuest = false;
                authModal.classList.add('hidden');
            } else {
                userId = null;
                isGuest = true;
            }
            
            updateUserStatus();
            loadChats();
        }


        // --- UI Switching & Auth Handlers ---
        authButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (isGuest) {
                authModal.classList.remove('hidden');
            } else {
                profileDropdown.classList.toggle('hidden');
            }
        });

        editProfileButton.addEventListener('click', () => {
            displayNameInput.value = auth.currentUser.displayName || '';
            profileModal.classList.remove('hidden');
            profileDropdown.classList.add('hidden');
        });

        window.addEventListener('click', () => {
            if (!profileDropdown.classList.contains('hidden')) {
                profileDropdown.classList.add('hidden');
            }
        });

        closeModalBtn.addEventListener('click', () => authModal.classList.add('hidden'));
        closeProfileModalBtn.addEventListener('click', () => profileModal.classList.add('hidden'));

        signoutButton.addEventListener('click', () => {
            if (auth) signOut(auth).catch(error => console.error("Sign out error:", error));
        });

        loginTab.addEventListener('click', () => {
            loginTab.classList.add('border-b-2', 'border-black', 'text-black');
            loginTab.classList.remove('text-slate-400');
            signupTab.classList.remove('border-b-2', 'border-black');
            signupTab.classList.add('text-slate-400');
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
        });

        signupTab.addEventListener('click', () => {
            signupTab.classList.add('border-b-2', 'border-black', 'text-black');
            signupTab.classList.remove('text-slate-400');
            loginTab.classList.remove('border-b-2', 'border-black');
            loginTab.classList.add('text-slate-400');
            signupForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        });

        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            const button = loginForm.querySelector('button');
            const originalContent = button.innerHTML;
            button.innerHTML = loadingSpinner;
            button.disabled = true;

            try { 
                await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value); 
            } catch (error) { 
                document.getElementById('login-error').textContent = error.message; 
            } finally {
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        });
        signupForm.addEventListener('submit', async e => {
            e.preventDefault();
            const button = signupForm.querySelector('button');
            const originalContent = button.innerHTML;
            button.innerHTML = loadingSpinner;
            button.disabled = true;

            try { 
                await createUserWithEmailAndPassword(auth, signupForm['signup-email'].value, signupForm['signup-password'].value); 
            } catch (error) { 
                document.getElementById('signup-error').textContent = error.message; 
            } finally {
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        });

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = displayNameInput.value.trim();
            if (!newName) return;

            const button = profileForm.querySelector('button');
            const originalContent = button.innerHTML;
            button.innerHTML = loadingSpinner;
            button.disabled = true;

            try {
                await updateProfile(auth.currentUser, { displayName: newName });
                await setDoc(doc(db, 'users', userId), { displayName: newName }, { merge: true });
                profileModal.classList.add('hidden');
                updateUserStatus();
            } catch (error) {
                document.getElementById('profile-error').textContent = error.message;
            } finally {
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        });

        // --- Data Handling ---
        function loadChats() {
            if (isGuest || !userId) loadChatsFromLocalStorage();
            else loadChatsFromFirestore();
        }
        function loadChatsFromLocalStorage() {
            const saved = localStorage.getItem('plutoGuestChats');
            allChats = saved ? JSON.parse(saved) : [];
            if (allChats.length === 0) {
                startNewChat();
            } else { 
                activeChatId = localStorage.getItem('plutoGuestActiveChatId') || allChats[0]?.id; 
                renderUI(); 
            }
        }
        function loadChatsFromFirestore() {
            if (!userId) return;
            const q = query(collection(db, 'users', userId, 'chats'));
            chatsUnsubscribe = onSnapshot(q, snapshot => {
                const firestoreChats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.id - a.id);
                
                if (isGenerating) {
                    allChats = firestoreChats;
                    renderChatPreviews();
                    return;
                }

                allChats = firestoreChats;
                if (allChats.length === 0) {
                    startNewChat();
                    return;
                }

                if (!activeChatId || !allChats.some(chat => String(chat.id) === String(activeChatId))) {
                    activeChatId = allChats[0]?.id || null;
                }
                renderUI();
            }, error => {
                console.error("Firestore snapshot error:", error);
                appendMessage("Could not load your chats. Please try again later.", "model", true);
            });
        }
        async function saveChat(chat) {
            const chatToSave = allChats.find(c => c.id === chat.id);
            if (!chatToSave) return;
            if (isGuest) {
                localStorage.setItem('plutoGuestChats', JSON.stringify(allChats));
            } else if (userId) {
                try {
                    await setDoc(doc(db, 'users', userId, 'chats', String(chat.id)), chat, { merge: true });
                } catch (error) {
                    console.error("Error saving chat to Firestore:", error);
                }
            }
        }
        async function deleteChatPersistence(chatId) {
            if (isGuest) {
                localStorage.setItem('plutoGuestChats', JSON.stringify(allChats));
            } else if (userId) {
                await deleteDoc(doc(db, 'users', userId, 'chats', String(chatId)));
            }
        }

        // --- Core Chat Functions ---
        async function startNewChat() {
            const newChat = { id: Date.now(), name: null, history: [] };
            allChats.unshift(newChat);
            activeChatId = newChat.id;
            await saveChat(newChat);
            renderUI();
        }
        function switchChat(chatId) {
            activeChatId = chatId;
            if (isGuest) localStorage.setItem('plutoGuestActiveChatId', String(activeChatId));
            renderUI();
        }
        async function deleteChat(e, chatId) {
            e.stopPropagation();
            const chatIdStr = String(chatId);
            allChats = allChats.filter(chat => String(chat.id) !== chatIdStr);
            if (String(activeChatId) === chatIdStr) activeChatId = allChats[0]?.id || null;
            await deleteChatPersistence(chatIdStr);
            if (allChats.length === 0) startNewChat();
            else renderUI();
        }
        async function editChatTitle(e, chatId) {
            e.stopPropagation();
            const chat = allChats.find(c => String(c.id) === String(chatId));
            if (!chat) return;
            const card = e.target.closest('.chat-preview-card');
            const p = card.querySelector('p');
            if (!p) return;
            const currentTitle = p.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'text-xs font-semibold text-slate-800 bg-white w-full rounded focus:outline-none focus:ring-1 focus:ring-black';
            p.replaceWith(input);
            input.focus();
            input.select();
            const save = async () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== currentTitle) {
                    chat.name = newTitle;
                    await saveChat(chat);
                }
                renderChatPreviews();
            };
            input.addEventListener('blur', save);
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') input.blur();
                else if (event.key === 'Escape') renderChatPreviews();
            });
        }

        // --- UI Rendering & State ---
        function updateUserStatus() {
            if (isGuest) {
                userStatusEl.textContent = "Guest Mode";
            } else {
                userStatusEl.textContent = auth.currentUser.displayName || auth.currentUser.email.split('@')[0];
            }
        }
        function renderUI() { renderChatPreviews(); renderActiveChat(); }
        function stopTyping() {
            if (typingInterval) { clearInterval(typingInterval); typingInterval = null; }
        }
        
        const stopGeneration = () => {
            if (responseAbortController) {
                responseAbortController.abort();
            }
            stopTyping();
            const placeholder = chatHistoryEl.querySelector('.is-thinking');
            if (placeholder) {
                placeholder.remove();
            }
            setGeneratingState(false);
        };

        function setGeneratingState(generating) {
            isGenerating = generating;
            messageInput.disabled = generating;
            if (generating) {
                sendButton.type = "button";
                sendButton.innerHTML = stopIcon;
                sendButton.onclick = stopGeneration;
            } else {
                sendButton.type = "submit";
                sendButton.innerHTML = sendIcon;
                sendButton.onclick = null;
                responseAbortController = null;
            }
        }
        
        // --- Agent Response ---
        async function getAgentResponse(userMessage, signal) {
            const activeChat = allChats.find(c => c.id == activeChatId);
            if (!activeChat) return { error: "Error: No active chat found." };

            const updatedHistory = [...activeChat.history, { role: 'user', parts: [{ text: userMessage }] }];
            
            activeChat.history = updatedHistory;
            if (activeChat.history.length === 1 && !activeChat.name) {
                activeChat.name = userMessage;
            }

            let systemPrompt = "You are Pluto, a helpful AI assistant."; // Default prompt
            try {
                if (db) { // Ensure db is initialized
                    const configDocRef = doc(db, 'settings', 'config');
                    const configDocSnap = await getDoc(configDocRef);

                    if (configDocSnap.exists() && configDocSnap.data().systemprompt) {
                        systemPrompt = configDocSnap.data().systemprompt;
                    }
                }
            } catch (error) {
                console.error("Error fetching system prompt:", error);
                // The function will continue with the default prompt
            }

            const systemInstruction = { role: "user", parts: [{ text: systemPrompt }] };

            const apiKey = ""; // The API key is injected by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const apiRequestBody = { contents: [systemInstruction, ...activeChat.history] };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(apiRequestBody), signal });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content.parts[0]) {
                    const agentReply = result.candidates[0].content.parts[0].text;
                    activeChat.history.push({ role: 'model', parts: [{ text: agentReply }] });
                    await saveChat(activeChat);
                    return { content: agentReply };
                }
                return { error: "Unexpected API response format." };
            } catch (error) {
                activeChat.history.pop(); 
                if (error.name === 'AbortError') return { error: "Response stopped.", aborted: true };
                console.error("Fetch Error:", error);
                return { error: `Sorry, I couldn't get a response. Please check your connection.` };
            }
        }
        
        // --- Initialize App ---
        initializeFirebase();
        sendButton.innerHTML = sendIcon;
        setInterval(() => {
            const now = new Date();
            const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            const hour = now.getHours();

            if (hour >= 5 && hour < 12) { // Morning
                timeIconEl.innerHTML = sunIcon;
            } else if (hour >= 12 && hour < 18) { // Afternoon
                timeIconEl.innerHTML = cloudSunIcon;
            } else { // Night
                timeIconEl.innerHTML = moonIcon;
            }

            timeDisplayEl.innerHTML = `
                <div class="font-bold">${new Intl.DateTimeFormat('en-US', timeOptions).format(now)}</div>
                <div class="text-xs">${new Intl.DateTimeFormat('en-US', dateOptions).format(now)}</div>
            `;
        }, 1000);
        
        // --- Canvas Script ---
        const canvas = document.getElementById('background-canvas');
        const ctx = canvas.getContext('2d');
        let particlesArray;
        function setupCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const symbols = ['+', '-', 'ร', 'รท'];
            particlesArray = [];
            let num = (canvas.height * canvas.width) / 9000;
            for (let i = 0; i < num; i++) {
                let size = Math.random() * 10 + 15; // Font size from 15px to 25px
                let x = Math.random() * (innerWidth - size * 2) + size;
                let y = Math.random() * (innerHeight - size * 2) + size;
                let dirX = (Math.random() * 0.4) - 0.2;
                let dirY = (Math.random() * 0.4) - 0.2;
                let symbol = symbols[Math.floor(Math.random() * symbols.length)];
                particlesArray.push({x, y, dirX, dirY, size, symbol});
            }
        }
        function animateCanvas() {
            requestAnimationFrame(animateCanvas);
            ctx.clearRect(0, 0, innerWidth, innerHeight);
            particlesArray.forEach(p => {
                ctx.font = `bold ${p.size}px Poppins`;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillText(p.symbol, p.x, p.y);

                if (p.x > canvas.width || p.x < 0) {
                    p.dirX = -p.dirX;
                }
                if (p.y > canvas.height || p.y < 0) {
                    p.dirY = -p.dirY;
                }
                p.x += p.dirX;
                p.y += p.dirY;
            });
        }
        window.addEventListener('resize', setupCanvas);
        setupCanvas();
        animateCanvas();

        // --- Make functions globally available ---
        window.startNewChat = startNewChat;
        window.switchChat = switchChat;
        window.deleteChat = deleteChat;
        window.editChatTitle = editChatTitle;

        // --- Helper functions ---
        function copyText(button, text) {
            const textArea = document.createElement('textarea');
            
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            textArea.style.opacity = '0';

            textArea.value = text;
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    button.innerHTML = checkIcon;
                    setTimeout(() => {
                        button.innerHTML = copyIcon;
                    }, 1500);
                } else {
                    console.error('Copy command failed.');
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            
            document.body.removeChild(textArea);
        }
        window.copyText = copyText;

        function renderChatPreviews() { 
            const newChatButton = `<button onclick="startNewChat()" title="New Chat" class="border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-center text-slate-400 hover:bg-slate-100 w-20 h-14 flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>`;
            const chatButtons = allChats.map(chat => {
                const title = chat.name || (chat.history.length > 0 ? chat.history[0].parts[0].text.substring(0, 20) : 'New Chat');
                return `<div class="chat-preview-card relative p-2 text-left bg-slate-100 rounded-lg hover:bg-slate-200 w-28 h-14 flex flex-col justify-between flex-shrink-0 cursor-pointer ${chat.id == activeChatId ? 'ring-2 ring-black' : ''}" onclick="switchChat('${chat.id}')">
                    <p class="text-xs font-semibold text-slate-800 chat-preview-card-content">${title}</p>
                    <div class="flex justify-end">
                         <button title="Edit Title" class="p-1 text-slate-400 hover:text-blue-500" onclick="editChatTitle(event, '${chat.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24" 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"></path></svg></button>
                    </div>
                    <button title="Delete" class="absolute top-1 right-1 p-1 text-slate-400 hover:text-red-500" onclick="deleteChat(event, '${chat.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24" 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>`;
            }).join('');
            chatPreviewsEl.innerHTML = newChatButton + chatButtons;
        }
        function renderActiveChat() { 
            chatHistoryEl.innerHTML = '';
            const activeChat = allChats.find(c => c.id == activeChatId);
            if (activeChat) activeChat.history.forEach(msg => appendMessage(msg.parts[0].text, msg.role, true));
        }

        function typeMessage(element, markdownText, callback) {
            stopTyping();
            let i = 0;
            const fullText = markdownText;

            typingInterval = setInterval(() => {
                if (typingInterval && i <= fullText.length) {
                    const substring = fullText.substring(0, i);
                    element.innerHTML = markdownConverter.makeHtml(substring);
                    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
                    i++;
                } else {
                    stopTyping();
                    element.innerHTML = markdownConverter.makeHtml(fullText);
                    if (callback) callback();
                }
            }, 15); 
        }

        function appendMessage(content, sender, isInitial = false) { 
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper group flex w-full items-end gap-2 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `prose max-w-full overflow-x-auto`;

            const copyButton = document.createElement('button');
            copyButton.className = `opacity-0 group-hover:opacity-100 flex items-center justify-center w-7 h-7 rounded-full bg-slate-200 hover:bg-slate-300 text-slate-600 flex-shrink-0 transition-all`;
            copyButton.title = "Copy text";
            copyButton.innerHTML = copyIcon;
            
            copyButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const textToCopy = wrapper.querySelector('.prose').innerText;
                copyText(copyButton, textToCopy);
            });

            if (sender === 'user' || isInitial) {
                contentDiv.innerHTML = markdownConverter.makeHtml(content);
            } else {
                wrapper.classList.add('is-thinking');
                contentDiv.innerHTML = `<img src="https://media.istockphoto.com/id/1331167052/vector/letter-p-paper-logo-template-design.jpg?s=612x612&w=0&k=20&c=HQVvPVRw6ePUu6rWPTP7TpqEDM_n7xJOhtccMxks2m8=" alt="Thinking..." class="w-8 h-8 rounded-full blinking-logo">`;
            }

            if (sender === 'user') {
                wrapper.appendChild(copyButton);
                wrapper.appendChild(contentDiv);
            } else {
                wrapper.appendChild(contentDiv);
                wrapper.appendChild(copyButton);
            }
            
            chatHistoryEl.appendChild(wrapper);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            return wrapper;
        }
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isGenerating) return;
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;
            
            appendMessage(userMessage, 'user', true);
            messageInput.value = '';
            setGeneratingState(true);
            
            const placeholder = appendMessage("", 'model', false);
            const contentDiv = placeholder.querySelector('.prose');

            responseAbortController = new AbortController();
            const result = await getAgentResponse(userMessage, responseAbortController.signal);
            
            if (result.aborted) {
                return;
            } 
            
            if (result.error) {
                contentDiv.innerHTML = markdownConverter.makeHtml(result.error);
                setGeneratingState(false);
            } else if (result.content) {
                typeMessage(contentDiv, result.content, () => {
                    setGeneratingState(false);
                });
            } else {
                placeholder.remove();
                setGeneratingState(false);
            }
        });
    </script>
</body>
</html>
